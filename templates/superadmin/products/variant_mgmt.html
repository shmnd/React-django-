{% include 'superadmin/layout/header.html' %}
{% load static %}

<style>
    .medical-card {
        border-top: 3px solid #ff5b5c;
    }

    .variant-card {
        border-top: 3px solid #00d27a;
    }

    /* Customization UI Styles */
    .customization-preview {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 30px;
        border: 1px dashed #ced4da;
    }

    .variant-group-label {
        font-weight: 600;
        margin-bottom: 12px;
        color: #495057;
        display: block;
    }

    /* Segmented Buttons */
    .btn-group-custom .btn-check:checked+.btn-outline-primary {
        background-color: #705ec8;
        color: white;
        border-color: #705ec8;
    }

    .btn-group-custom .btn {
        margin-right: 5px;
        border-radius: 6px !important;
        padding: 8px 16px;
    }

    /* Image Cards */
    .image-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
    }

    .image-option-card {
        width: 100px;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        padding: 8px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
        background: white;
    }

    .image-option-card:hover {
        border-color: #705ec8;
    }

    .image-option-card img {
        width: 100%;
        height: 60px;
        object-fit: cover;
        border-radius: 4px;
        margin-bottom: 5px;
    }

    .image-option-card span {
        font-size: 11px;
        display: block;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    /* Color Picker Row */
    .color-selection {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    .color-dot {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        border: 2px solid transparent;
        cursor: pointer;
        transition: transform 0.2s;
        padding: 2px;
    }

    .color-dot:hover {
        transform: scale(1.1);
    }

    .color-dot-inner {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        border: 1px solid rgba(0, 0, 0, 0.1);
    }
</style>

<div class="main-content app-content mt-0">
    <div class="side-app">
        <div class="main-container container-fluid">
            <div class="page-header">
                <h1 class="page-title">Manage Product: {{ product.name }}</h1>
                <div>
                    <a href="{% url 'product_edit' product.id %}" class="btn btn-primary me-2">
                        <i class="fe fe-edit me-2"></i>Edit Info</a>
                    <a href="{% url 'product_list' %}" class="btn btn-light">
                        <i class="fe fe-arrow-left me-2"></i>Back to Products</a>
                </div>
            </div>

            <div class="row">
                <!-- 1. Customization Preview (Data-Driven UI) -->
                <div class="col-lg-12">
                    <div class="card shadow-sm mb-5">
                        <div class="card-header bg-primary-transparent">
                            <h3 class="card-title text-primary"><i class="fe fe-eye me-2"></i>Customer Customization
                                Preview</h3>
                        </div>
                        <div class="card-body">
                            <div class="customization-preview">
                                {% if not product_variant_types %}
                                <div class="text-center py-4 text-muted">
                                    No variants configured to show in preview.
                                </div>
                                {% endif %}

                                <div class="row">
                                    {% for pvt in product_variant_types %}
                                    <div class="col-md-6 mb-4">
                                        <label class="variant-group-label">{{ pvt.variant_type.name }} 
                                            {% if pvt.variant_type.is_required %}<span class="text-danger">*</span>{% endif %}</label>

                                        {% if pvt.variant_type.display_type == 'segmented_buttons' %}
                                        <div class="btn-group btn-group-custom" role="group">
                                            {% for opt in pvt.options.all %}
                                            <input type="radio" class="btn-check" name="preview_{{ pvt.id }}"
                                                id="prev_opt_{{ opt.id }}" autocomplete="off">
                                            <label class="btn btn-outline-primary" for="prev_opt_{{ opt.id }}">{{
                                                opt.name }}</label>
                                            {% endfor %}
                                        </div>

                                        {% elif pvt.variant_type.display_type == 'image_cards' %}
                                        <div class="image-grid">
                                            {% for opt in pvt.options.all %}
                                            <div class="image-option-card">
                                                {% if opt.image %}
                                                <img src="{{ opt.image.url }}" alt="{{ opt.name }}">
                                                {% else %}
                                                <div class="bg-light d-flex align-items-center justify-content-center"
                                                    style="height:60px; border-radius:4px;"><i class="fe fe-image"></i>
                                                </div>
                                                {% endif %}
                                                <span>{{ opt.name }}</span>
                                            </div>
                                            {% endfor %}
                                        </div>

                                        {% elif pvt.variant_type.display_type == 'color_picker' %}
                                        <div class="color-selection">
                                            {% for opt in pvt.options.all %}
                                            <div class="color-dot" title="{{ opt.name }}">
                                                <div class="color-dot-inner"
                                                    style="background-color: {{ opt.color_code|default:'#ddd' }};">
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>

                                        {% elif pvt.variant_type.display_type == 'dropdown' %}
                                        <select class="form-select">
                                            <option value="">Select {{ pvt.variant_type.name }}...</option>
                                            {% for opt in pvt.options.all %}
                                            <option value="{{ opt.value }}">{{ opt.name }}</option>
                                            {% endfor %}
                                        </select>

                                        {% elif pvt.variant_type.display_type == 'text_input' %}
                                        <input type="text" class="form-control"
                                            placeholder="Enter {{ pvt.variant_type.name }}...">
                                        {% endif %}
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 2. Management Section -->
                <div class="col-lg-12">
                    <div class="card variant-card shadow-sm">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h3 class="card-title text-success"><i class="fe fe-settings me-2"></i>Variant Configuration
                            </h3>
                            <button class="btn btn-sm btn-success" data-bs-toggle="modal"
                                data-bs-target="#addVariantTypeModal">
                                <i class="fe fe-plus me-1"></i>Attach New Variant Type
                            </button>
                        </div>
                        <div class="card-body">
                            {% for pvt in product_variant_types %}
                            <div class="variant-type-block mb-4 p-4 border rounded bg-light-50">
                                <div class="d-flex justify-content-between align-items-starts mb-3">
                                    <div>
                                        <h4 class="mb-1">{{ pvt.variant_type.name }}</h4>
                                        <div class="small">
                                            <span class="badge bg-primary-transparent text-primary me-2">Type: 
                                                {{ pvt.variant_type.get_display_type_display }}</span>
                                            <span class="badge bg-info-transparent text-info me-2">Selection: 
                                                {{ pvt.variant_type.get_selection_type_display }}</span>
                                            {% if pvt.variant_type.is_required %}
                                            <span class="badge bg-danger-transparent text-danger">Required</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="btn-group">
                                        <button class="btn btn-sm btn-outline-success btn-add-option"
                                            data-pvt-id="{{ pvt.id }}"
                                            data-display-type="{{ pvt.variant_type.display_type }}"
                                            data-variant-name="{{ pvt.variant_type.name }}">
                                            <i class="fe fe-plus"></i> Add Option
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger btn-remove-variant"
                                            data-pvt-id="{{ pvt.id }}">
                                            <i class="fe fe-trash-2"></i>
                                        </button>
                                    </div>
                                </div>

                                <div class="row g-3">
                                    {% for option in pvt.options.all %}
                                    <div class="col-md-4 col-lg-3" id="option-{{ option.id }}">
                                        <div class="card mb-0 shadow-none border">
                                            <div class="card-body p-3">
                                                <div class="d-flex align-items-center mb-2">
                                                    {% if pvt.variant_type.display_type == 'image_cards' and option.image %}
                                                    <img src="{{ option.image.url }}" class="rounded me-2"
                                                        style="width:30px; height:30px; object-fit:cover;">
                                                    {% elif pvt.variant_type.display_type == 'color_picker' %}
                                                    <span class="me-2 rounded-circle border"
                                                        style="width:20px; height:20px; background:{{ option.color_code|default:'#ddd' }};"></span>
                                                    {% endif %}
                                                    <span class="fw-bold text-truncate">{{ option.name }}</span>
                                                </div>
                                                <div class="text-end">
                                                    <button class="btn btn-xs btn-info-transparent btn-edit-option"
                                                        data-id="{{ option.id }}" data-name="{{ option.name }}"
                                                        data-value="{{ option.value }}"
                                                        data-color="{{ option.color_code }}"
                                                        data-text="{{ option.text_content }}"
                                                        data-active="{{ option.is_active|yesno:'true,false' }}"
                                                        data-pvt-id="{{ pvt.id }}"
                                                        data-display-type="{{ pvt.variant_type.display_type }}">
                                                        <i class="fe fe-edit"></i>
                                                    </button>
                                                    <button class="btn btn-xs btn-danger-transparent btn-delete-option"
                                                        data-id="{{ option.id }}">
                                                        <i class="fe fe-trash-2"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% empty %}
                                    <div class="col-12 text-muted small italic">No options defined for this variant.
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Add Variant Type to Product -->
<div class="modal fade" id="addVariantTypeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Attach Variant Type</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <form id="addVariantTypeForm">
                    <div class="mb-3">
                        <label class="form-label">Select Template</label>
                        <select name="variant_type" class="form-select" required>
                            <option value="">Choose...</option>
                            {% for vt in all_variant_types %}
                            <option value="{{ vt.id }}">{{ vt.name }} ({{ vt.get_display_type_display }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="text-end">
                        <button type="submit" class="btn btn-primary px-4">Add to Product</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Manage Variant Option -->
<div class="modal fade" id="optionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="optionModalTitle">Manage Option</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <form id="optionForm" enctype="multipart/form-data">
                    <input type="hidden" name="action" id="optionAction" value="add">
                    <input type="hidden" name="option_id" id="editOptionId">
                    <input type="hidden" name="product_variant_type" id="pvtIdInput">

                    <div class="mb-3">
                        <label class="form-label">Label (Display Name)</label>
                        <input type="text" name="name" id="optionName" class="form-control"
                            placeholder="e.g. Small, Red, Soft" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Value (Internal Code)</label>
                        <input type="text" name="value" id="optionValue" class="form-control"
                            placeholder="e.g. S, #FF0000, soft_type">
                    </div>

                    <div id="colorFields" class="mb-3 d-none">
                        <label class="form-label">Color Code</label>
                        <div class="input-group">
                            <input type="color" class="form-control form-control-color" id="colorPicker"
                                value="#000000">
                            <input type="text" name="color_code" id="optionColorCode" class="form-control"
                                placeholder="#000000">
                        </div>
                    </div>

                    <div id="imageFields" class="mb-3 d-none">
                        <label class="form-label">Upload Image</label>
                        <input type="file" name="image" class="form-control" accept="image/*">
                        <div id="imagePreview" class="mt-2 d-none text-center">
                            <img src="" class="img-thumbnail" style="max-height: 100px;">
                        </div>
                    </div>

                    <div id="textFields" class="mb-3 d-none">
                        <label class="form-label">Extended Text Content</label>
                        <textarea name="text_content" id="optionTextContent" class="form-control" rows="3"></textarea>
                    </div>

                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" name="is_active" id="optionActive" checked>
                        <label class="form-check-label ms-2">Is Active</label>
                    </div>

                    <div class="text-end mt-4">
                        <button type="submit" class="btn btn-success px-5" id="optionSubmitBtn">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const csrfToken = '{{ csrf_token }}';

        // Add Variant Type Logic
        const addVariantTypeForm = document.getElementById('addVariantTypeForm');
        addVariantTypeForm.onsubmit = function (e) {
            e.preventDefault();
            fetch("{% url 'add_variant_type_to_product' product.id %}", {
                method: 'POST',
                body: new FormData(this),
                headers: { 'X-CSRFToken': csrfToken }
            }).then(res => res.json()).then(data => {
                if (data.status === 'success') location.reload();
                else alert(data.message);
            });
        };

        // Remove Variant Type Logic
        document.querySelectorAll('.btn-remove-variant').forEach(btn => {
            btn.onclick = function () {
                if (!confirm("Remove this variant and ALL its options?")) return;
                const formData = new FormData();
                formData.append('pvt_id', this.dataset.pvtId);
                fetch("{% url 'remove_variant_type_from_product' product.id %}", {
                    method: 'POST',
                    body: formData,
                    headers: { 'X-CSRFToken': csrfToken }
                }).then(res => res.json()).then(data => {
                    if (data.status === 'success') location.reload();
                    else alert(data.message);
                });
            };
        });

        const optionModal = new bootstrap.Modal(document.getElementById('optionModal'));
        const colorFields = document.getElementById('colorFields');
        const imageFields = document.getElementById('imageFields');
        const textFields = document.getElementById('textFields');
        const colorPicker = document.getElementById('colorPicker');
        const optionColorCode = document.getElementById('optionColorCode');

        colorPicker.oninput = function () { optionColorCode.value = this.value; };
        optionColorCode.oninput = function () { colorPicker.value = this.value; };

        function resetModalGroups() {
            colorFields.classList.add('d-none');
            imageFields.classList.add('d-none');
            textFields.classList.add('d-none');
        }

        function toggleFieldsByDisplayType(displayType) {
            console.log('ðŸŽ¨ Display Type:', displayType); // DEBUG
            resetModalGroups();

            // Show specific fields based on display type
            switch (displayType) {
                case 'color_picker':
                    console.log('âœ… Showing color picker fields');
                    colorFields.classList.remove('d-none');
                    break;

                case 'image_cards':
                    console.log('âœ… Showing image upload fields');
                    imageFields.classList.remove('d-none');
                    break;

                case 'text_input':
                    console.log('âœ… Showing text content fields');
                    textFields.classList.remove('d-none');
                    break;

                case 'segmented_buttons':
                case 'dropdown':
                    // For dropdown and segmented, Name + Value are enough (always visible)
                    console.log('âœ… Using default Name + Value fields');
                    break;

                default:
                    console.warn('âš ï¸ Unknown display type:', displayType);
            }
        }

        document.querySelectorAll('.btn-add-option').forEach(btn => {
            btn.onclick = function () {
                const pvtId = this.dataset.pvtId;
                const displayType = this.dataset.displayType;
                const variantName = this.dataset.variantName;

                console.log('ðŸ”˜ Add Option Clicked');
                console.log('  PVT ID:', pvtId);
                console.log('  Display Type:', displayType);
                console.log('  Variant Name:', variantName);

                document.getElementById('optionModalTitle').innerText = "Add Option to " + variantName;
                document.getElementById('optionAction').value = "add";
                document.getElementById('pvtIdInput').value = pvtId;
                document.getElementById('optionName').value = "";
                document.getElementById('optionValue').value = "";
                document.getElementById('optionColorCode').value = "";
                document.getElementById('optionTextContent').value = "";
                document.getElementById('optionActive').checked = true;
                document.getElementById('imagePreview').classList.add('d-none');

                toggleFieldsByDisplayType(displayType);
                optionModal.show();
            };
        });

        document.querySelectorAll('.btn-edit-option').forEach(btn => {
            btn.onclick = function () {
                const ds = this.dataset;
                document.getElementById('optionModalTitle').innerText = "Edit Option: " + ds.name;
                document.getElementById('optionAction').value = "edit";
                document.getElementById('editOptionId').value = ds.id;
                document.getElementById('pvtIdInput').value = ds.pvtId;
                document.getElementById('optionName').value = ds.name;
                document.getElementById('optionValue').value = ds.value;
                document.getElementById('optionColorCode').value = ds.color || "";
                document.getElementById('optionTextContent').value = ds.text || "";
                document.getElementById('optionActive').checked = ds.active === 'true';

                toggleFieldsByDisplayType(ds.displayType);

                if (ds.displayType === 'image_cards') {
                    const previewImg = document.getElementById('imagePreview');
                    const rowImg = document.querySelector(`#option-${ds.id} img`);
                    if (rowImg) {
                        previewImg.querySelector('img').src = rowImg.src;
                        previewImg.classList.remove('d-none');
                    }
                }
                optionModal.show();
            };
        });

        const optionForm = document.getElementById('optionForm');
        optionForm.onsubmit = function (e) {
            e.preventDefault();
            fetch("{% url 'manage_variant_option' %}", {
                method: 'POST',
                body: new FormData(this),
                headers: { 'X-CSRFToken': csrfToken }
            }).then(res => res.json()).then(data => {
                if (data.status === 'success') location.reload();
                else alert("Error: " + data.message);
            });
        };

        document.querySelectorAll('.btn-delete-option').forEach(btn => {
            btn.onclick = function () {
                if (!confirm("Are you sure?")) return;
                const formData = new FormData();
                formData.append('action', 'delete');
                formData.append('option_id', this.dataset.id);
                fetch("{% url 'manage_variant_option' %}", {
                    method: 'POST',
                    body: formData,
                    headers: { 'X-CSRFToken': csrfToken }
                }).then(res => res.json()).then(data => {
                    if (data.status === 'success') location.reload();
                    else alert(data.message);
                });
            };
        });
    });
</script>

{% include 'superadmin/layout/footer.html' %}